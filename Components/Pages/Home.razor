@page "/"
@rendermode InteractiveServer
@using SuperBowlSquares.Models
@inject SuperBowlSquares.Services.GameStateService GameStateService

<PageTitle>Super Bowl Squares</PageTitle>

<div class="container">
    <h1>üèà Super Bowl Squares üèà</h1>
    <p class="subtitle">
        <span class="live-indicator connected"></span>
        Live - Updates from server state
    </p>

    @if (!string.IsNullOrEmpty(statusMessage))
    {
        <div class="status-message @statusClass">
            @statusMessage
        </div>
    }

    <div class="controls">
        <button class="btn" @onclick="ShowRandomizeConfirm">üé≤ Randomize Numbers</button>
        <button class="btn danger" @onclick="ShowResetConfirm">üîÑ Reset Board</button>
    </div>

    <div class="grid-wrapper">
        <div class="grid-container">
            <div class="grid">
                @* Corner cell *@
                <div class="cell header corner">AFC</div>

                @* Top row - column numbers *@
                @for (int i = 0; i < 10; i++)
                {
                    <div class="cell header">
                        @(gameState.NumbersAssigned ? gameState.ColNumbers[i].ToString() : "?")
                    </div>
                }

                @* Grid squares *@
                @for (int row = 0; row < 10; row++)
                {
                    var currentRow = row;
                    @* Row number *@
                    <div class="cell header">
                        @(gameState.NumbersAssigned ? gameState.RowNumbers[currentRow].ToString() : "?")
                    </div>

                    @* Squares *@
                    @for (int col = 0; col < 10; col++)
                    {
                        var index = row * 10 + col;
                        var currentIndex = index;
                        var owner = gameState.Squares[index];
                        var cellClass = owner != null ? "cell claimed" : "cell";

                        <div class="@cellClass" @onclick="() => SelectSquare(currentIndex)">
                            @owner
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <div class="info-panel">
        <h3>Board Statistics</h3>
        <div class="stats">
            <div class="stat-box">
                <div class="stat-label">Squares Claimed</div>
                <div class="stat-value">@gameState.ClaimedCount/100</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Players</div>
                <div class="stat-value">@gameState.PlayerCount</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Numbers Assigned</div>
                <div class="stat-value">@(gameState.NumbersAssigned ? "Yes" : "No")</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Connection</div>
                <div class="stat-value">üü¢ Server-backed</div>
            </div>
        </div>
    </div>
</div>

@* Claim Modal *@
@if (showClaimModal)
{
    <div class="modal active">
        <div class="modal-content">
            <h2>Claim Square</h2>
            <p>Enter your name to claim this square:</p>
            <input type="text" @bind="playerName" @bind:event="oninput" 
                   placeholder="Your name" class="modal-input" 
                   @onkeypress="HandleKeyPress" />
            <div class="modal-buttons">
                <button class="btn" @onclick="ConfirmClaim">Claim</button>
                <button class="btn secondary" @onclick="CancelClaim">Cancel</button>
            </div>
        </div>
    </div>
}

@* Confirm Dialogs *@
@if (showRandomizeConfirm)
{
    <div class="modal active">
        <div class="modal-content">
            <h2>Randomize Numbers?</h2>
            <p>This will randomly assign numbers 0-9 to rows and columns. Continue?</p>
            <div class="modal-buttons">
                <button class="btn" @onclick="ConfirmRandomize">Yes, Randomize</button>
                <button class="btn secondary" @onclick="() => showRandomizeConfirm = false">Cancel</button>
            </div>
        </div>
    </div>
}

@if (showResetConfirm)
{
    <div class="modal active">
        <div class="modal-content">
            <h2>Reset Board?</h2>
            <p>This will clear the entire board. Are you sure?</p>
            <div class="modal-buttons">
                <button class="btn danger" @onclick="ConfirmReset">Yes, Reset</button>
                <button class="btn secondary" @onclick="() => showResetConfirm = false">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private GameState gameState = new();
    private string statusMessage = string.Empty;
    private string statusClass = string.Empty;

    private bool showClaimModal = false;
    private bool showRandomizeConfirm = false;
    private bool showResetConfirm = false;
    private int selectedSquare = -1;
    private string playerName = string.Empty;

    protected override Task OnInitializedAsync()
    {
        gameState = GameStateService.GetState();
        return Task.CompletedTask;
    }

    private void SelectSquare(int index)
    {
        if (gameState.Squares[index] != null)
        {
            ShowStatus($"This square is already claimed by {gameState.Squares[index]}", true);
            return;
        }

        selectedSquare = index;
        playerName = string.Empty;
        showClaimModal = true;
    }

    private Task ConfirmClaim()
    {
        if (string.IsNullOrWhiteSpace(playerName))
        {
            ShowStatus("Please enter your name", true);
            return Task.CompletedTask;
        }

        if (selectedSquare >= 0)
        {
            if (GameStateService.ClaimSquare(selectedSquare, playerName.Trim()))
            {
                gameState = GameStateService.GetState();
                ShowStatus($"Square claimed by {playerName}!");
            }
            else
            {
                ShowStatus($"This square is already claimed", true);
            }

            showClaimModal = false;
            selectedSquare = -1;
            playerName = string.Empty;
        }

        return Task.CompletedTask;
    }

    private void CancelClaim()
    {
        showClaimModal = false;
        selectedSquare = -1;
        playerName = string.Empty;
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await ConfirmClaim();
        }
    }

    private void ShowRandomizeConfirm()
    {
        showRandomizeConfirm = true;
    }

    private Task ConfirmRandomize()
    {
        GameStateService.RandomizeNumbers();
        gameState = GameStateService.GetState();
        ShowStatus("Numbers randomized!");
        showRandomizeConfirm = false;
        return Task.CompletedTask;
    }

    private void ShowResetConfirm()
    {
        showResetConfirm = true;
    }

    private Task ConfirmReset()
    {
        GameStateService.ResetBoard();
        gameState = GameStateService.GetState();
        ShowStatus("Board reset!");
        showResetConfirm = false;
        return Task.CompletedTask;
    }

    private void ShowStatus(string message, bool isError = false)
    {
        statusMessage = message;
        statusClass = isError ? "error" : "success";
        StateHasChanged();

        Task.Delay(3000).ContinueWith(_ =>
        {
            statusMessage = string.Empty;
            InvokeAsync(StateHasChanged);
        });
    }

    // No disposal required - no external connections
}
